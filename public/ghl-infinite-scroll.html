<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Messages Infinite Scroll Grid</title>
    <!--
      GHL Infinite Scroll Integration
      --------------------------------
      How to use:
      1. Deploy the getMessages Cloud Function:
         - From the project root, run:
             firebase deploy --only functions:getMessages
      2. Note the deployed HTTPS URL for getMessages, e.g.:
             https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/getMessages
      3. Replace FUNCTION_URL below with your function's URL.
      4. Copy everything inside <body> ... </body> into a GHL Custom Code element.
         (If GHL supports full HTML docs, you can paste the whole file.)
      5. Ensure your Firestore collection is:
           - Collection: "messages"
           - Fields on each document:
               title: string
               content or text: string
               createdAt: Firestore Timestamp
         Firestore auto-creates a single-field index on createdAt for the orderBy.
    -->
    <style>
      :root {
        color-scheme: light dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f4f5fb;
        color: #111827;
      }

      .page-wrapper {
        min-height: 100vh;
        padding: 32px 16px 64px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 24px;
      }

      .header-title {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .header-subtitle {
        font-size: 0.95rem;
        color: #6b7280;
      }

      #message-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        align-items: stretch;
      }

      .card {
        background: #ffffff;
        border-radius: 14px;
        padding: 18px 18px 16px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.3);
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition:
          transform 0.16s ease-out,
          box-shadow 0.16s ease-out,
          border-color 0.16s ease-out;
        background-image: radial-gradient(
            circle at top left,
            rgba(59, 130, 246, 0.06),
            transparent 55%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(236, 72, 153, 0.06),
            transparent 55%
          );
      }

      .card:hover {
        transform: translateY(-3px) translateZ(0);
        box-shadow: 0 16px 35px rgba(15, 23, 42, 0.16);
        border-color: rgba(59, 130, 246, 0.6);
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #4f46e5;
      }

      .card-body {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #111827;
      }

      .card-meta {
        margin-top: 8px;
        font-size: 0.78rem;
        color: #6b7280;
        display: flex;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
      }

      .card-meta span {
        white-space: nowrap;
      }

      .status-bar {
        margin-top: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        border: 3px solid rgba(148, 163, 184, 0.4);
        border-top-color: #4f46e5;
        animation: spin 0.8s linear infinite;
      }

      .status-text {
        font-size: 0.85rem;
        color: #6b7280;
      }

      .error-box {
        margin-top: 16px;
        padding: 10px 12px;
        border-radius: 8px;
        background: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
        font-size: 0.85rem;
        width: 100%;
        max-width: 480px;
      }

      .error-box strong {
        font-weight: 600;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 640px) {
        .page-wrapper {
          padding: 20px 12px 40px;
        }

        .header-title {
          font-size: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <header class="header">
        <div class="header-title">Live Gratitude Wall</div>
        <div class="header-subtitle">
          Messages of appreciation, updated in real time as visitors scroll.
        </div>
      </header>

      <main id="message-grid" aria-live="polite"></main>

      <div class="status-bar">
        <div id="loading" class="spinner" style="display: none"></div>
        <div id="statusText" class="status-text"></div>
        <div id="errorBox" class="error-box" style="display: none"></div>
      </div>
    </div>

    <script>
      // Replace this with your deployed getMessages Cloud Function URL.
      // Example:
      // const FUNCTION_URL =
      //   "https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/getMessages";
      const FUNCTION_URL =
        "https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/getMessages";

      const gridEl = document.getElementById("message-grid");
      const loadingEl = document.getElementById("loading");
      const statusTextEl = document.getElementById("statusText");
      const errorBoxEl = document.getElementById("errorBox");

      let lastDocId = null;
      let isLoading = false;
      let hasMore = true;
      const PAGE_SIZE = 20;

      function escapeHtml(unsafe) {
        if (typeof unsafe !== "string") return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function setLoading(isBusy) {
        isLoading = isBusy;
        loadingEl.style.display = isBusy ? "block" : "none";
      }

      function setStatus(message) {
        statusTextEl.textContent = message || "";
      }

      function showError(message) {
        if (!message) {
          errorBoxEl.style.display = "none";
          errorBoxEl.textContent = "";
          return;
        }
        errorBoxEl.style.display = "block";
        errorBoxEl.innerHTML =
          "<strong>Something went wrong.</strong> " + escapeHtml(message);
      }

      function formatDate(isoString) {
        if (!isoString) return "";
        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) return "";
        return date.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function appendMessages(messages) {
        if (!Array.isArray(messages) || messages.length === 0) return;

        const fragment = document.createDocumentFragment();

        messages.forEach((msg) => {
          const title = escapeHtml(msg.title || "New message");
          const body =
            escapeHtml(msg.content || msg.text || msg.message || "") ||
            "(no content)";
          const createdAt = formatDate(msg.createdAt);

          const card = document.createElement("article");
          card.className = "card";

          const titleEl = document.createElement("div");
          titleEl.className = "card-title";
          titleEl.textContent = title;

          const bodyEl = document.createElement("div");
          bodyEl.className = "card-body";
          bodyEl.textContent = body;

          const metaEl = document.createElement("div");
          metaEl.className = "card-meta";

          if (createdAt) {
            const dateSpan = document.createElement("span");
            dateSpan.textContent = createdAt;
            metaEl.appendChild(dateSpan);
          }

          card.appendChild(titleEl);
          card.appendChild(bodyEl);
          if (metaEl.childNodes.length > 0) {
            card.appendChild(metaEl);
          }

          fragment.appendChild(card);
        });

        gridEl.appendChild(fragment);
      }

      async function fetchNextPage() {
        if (!FUNCTION_URL || FUNCTION_URL.indexOf("YOUR-PROJECT-ID") !== -1) {
          showError(
            "Please configure FUNCTION_URL with your deployed Cloud Function URL."
          );
          return;
        }

        if (isLoading || !hasMore) {
          return;
        }

        setLoading(true);
        showError("");
        setStatus("Loading messages...");

        try {
          const response = await fetch(FUNCTION_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              lastDocId: lastDocId,
              limit: PAGE_SIZE,
            }),
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(
              "HTTP " + response.status + " " + response.statusText + ": " + text
            );
          }

          const payload = await response.json();
          const messages = payload.messages || [];
          appendMessages(messages);

          lastDocId = payload.lastDocId || null;
          hasMore = Boolean(payload.hasMore);

          if (!hasMore) {
            setStatus("Youâ€™ve reached the end of the wall.");
          } else {
            setStatus("");
          }
        } catch (err) {
          console.error("Error loading messages:", err);
          showError(err.message || "Failed to load messages.");
          setStatus("");
        } finally {
          setLoading(false);
        }
      }

      function throttle(fn, wait) {
        let lastTime = 0;
        let timeoutId = null;

        return function throttled() {
          const now = Date.now();
          const remaining = wait - (now - lastTime);

          if (remaining <= 0) {
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
            lastTime = now;
            fn();
          } else if (!timeoutId) {
            timeoutId = setTimeout(() => {
              lastTime = Date.now();
              timeoutId = null;
              fn();
            }, remaining);
          }
        };
      }

      const handleScroll = throttle(() => {
        if (!hasMore || isLoading) return;

        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 500;

        if (scrollPosition >= threshold) {
          fetchNextPage();
        }
      }, 200);

      window.addEventListener("scroll", handleScroll, { passive: true });

      // Initial load.
      fetchNextPage();
    </script>
  </body>
</html>

